---
layout: post
title: "Morplus SDK - Wormhole Vulnerability"
description: ""
date: 2015-11-06
categories: vulnerability 
tags: []
---

 이 포스트는 [Setting the Record Straight on Moplus SDK and the Wormhole Vulnerability](http://blog.trendmicro.com/trendlabs-security-intelligence/setting-the-record-straight-on-moplus-sdk-and-the-wormhole-vulnerability/) 포스트를 번역한 글입니다.

 최근 Baidu에서 만든 Moplus라는 SDK에서 심각한 취약점이 발견되었다. Wormhole vulnerability라고 불리고, 현재 약 14,000 여개의 앱이 integration되어 있으며, 약 1억명의 안드로이드 사용자 들에게 영향을 줄 수 있는 취약점이다. Device가 인터넷 환경에 연결되어 있기만 하면 phising page를 보내거나, faking SMS를 보내거나, local file을 remote server로 전송하거나, 유저의 동의 없이 app을 설치하는 것도 가능하다고 한다. 구체적으로 Moplus SDK가 어떻게 취약점을 가지고 있는지 보자.

 ![A malware uses the Moplus SDK to silently install itself on the device.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus1.jpg) 

 분석을 위해, Baidu Map (com.baidu.BaiduMap, 8.7.0) 과 “奇闻异录” (com.ufo.dcb.lingyi, 1.3) 를 사용하였다. 

 ![Moplus SDK included in com.ufo.dcb.lingyi](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus21.jpg)

 ![Moplus SDK included in com.baidu.BaiduMap](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus3.jpg)

 Moplus SDK가 다른 앱들과 어떻게 integration이 되었는지 먼저 살펴보자. Moplus SDK는 application과 독립적으로 integration이 되었는데, com.baidu.android.moplus.MoPlusService 라는 Main Service가 broadcast receivers (on boot event 포함) 을 통해 trigger된다.

 ![Moplus is integrated into an independent background. In effect, the malicious process will auto-start at every device boot up.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus4.jpg)

 사용자가 application을 실행하게 되면, Moplus SDK가 background로 local http server를 실행하게 된다. 이 과정에서 간단한 Open Source인 [NanoHttpd](https://github.com/NanoHttpd/nanohttpd)를 integration하였다.

 ![Moplus SDK integrates and modifies NanoHttpd into its code.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus5.jpg)

 이 HTTP Server에 bind된 TCP port는 application마다 서로 다른데, com.ufo.dcb.lingyi는 port 6259에 bind되어 있고 com.baidu.BaiduMap는 port 40310에 bind되어 있다.

 ![TCP port binded to local HTTP server is not always same.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus6.jpg)

 이 HTTP Server는 다른 remote client로부터 해당 TCP Port로 들어온 메세지를 받아 파싱한다. 그 후 "server"라는 function을 override한 function을 호출하여 task를 실행한다.

 ![Monitor HTTP requests from socket connection](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus7.jpg)

 ![Override “serve” function to call its own malicious tasks](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus8.jpg)
 
 This is a typical command & control(C&C) attack model. Compare with traditional C&C attack, the only difference is in this case, the server is at the user side, but attack client can be anywhere. There are lots of malicious functionalities like downloading and uploading of files etc. involved in the SDK, each serve as a single class file.

 ![Malicious functionalities supported by Moplus SDK](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus9.jpg)

 ![Map between malicious commands and their corresponding source classes](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus10.jpg)

 Based on the above screenshots, an attacker can remotely get locations, searchbox infos, package information and other sensitive data from user devices. It can remotely add contacts, scan download files and upload specific files on user devices. All of these can be simply done by sending an HTTP request from anywhere.

 ![A case of batch inserts arbitrary contacts](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus11.jpg)

A special command, “sendintent,” can be used to send local intent on devices. As such, this can remotely make phone calls, send bogus messages, and install arbitrary apps without the user’s consent.

 ![A command dubbed as “sendintent” can be used by an attacker to do malicious controls on the user device.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus12.jpg)

The SDK also supports silent APK installation and differentiate rooted devices.

 ![Support installing application silently](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus13.jpg)

 ![Differentiate root users to do more aggressive attacks](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus14.jpg)

These details clearly solidify our findings that it is a backdoor malware.  An attack can be done to any devices already infected by Moplus SDK. We have a short demo on Nexus 6 with Android 6.0 up to date (see figures 16-18). When the Baidu Map is launched, one can find that the malicious service (bdservice_v1) is always running in the background.

 ![Malicious service, bdservice_v1 is always running in the background.](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus15.jpg)

 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus16.jpg)
 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus17.jpg)
 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus18.jpg)

Figures 16-18.  In this series of images, we depicted how another contact is added to the mobile device. 

Since there is no identity authentication in the local HTTP server (which is set up by Moplus SDK), an attack can be triggered not only by an App developer but by anyone. With just one command, an attacker or cybercriminal can remotely control the infected device. In addition, they only need to scan the full network segment with NMAP to test TCP port 6259 or 40310 status. All Android devices marked with port status, OPEN can possibly be remotely controlled. Note that all devices under the same LAN as well as under the same 3G/4G networks can be attacked.

This is a critical issue, perhaps even worse than Stagefright vulnerability that requires phishing links to web pages or user phone number, which are then used to send malicious MMS. With this security issue, attackers just simply scan the network IP and require no action from the user’s end or any social engineering attacks.

Other findings and countermeasures

We have detected a malware (ANDROIDOS_WORMHOLE.HRXA) in the wild that uses Moplus SDK to automatically and periodically deploy unwanted applications. When it comes to user devices, the applications will be installed silently if it is rooted.

Sha1: 2FA40A5302D92FB0C5C64CF6197F2D671BA7C30D.

What are the apps that integrated Moplus SDK?

Moplus SDK is not an open SDK which can be only possibly used by Baidu. Based on our data, some of the 14,112 apps that integrated this SDK have different versions or different SHA1s. There are 4,014 on Baidu official apps among them. As some of these used earlier versions, it is very likely that users don’t maintain the latest version of apps for their usage. The top 20 hit applications are list below:

 - com.qiyi.video
 - com.baidu.video
 - com.baidu.BaiduMap
 - com.baidu.browser.apps
 - com.baidu.appsearch
 - com.nd.android.pandahome2
 - com.hiapk.marketpho
 - com.baidu.hao123
 - com.baidu.searchbox
 - tv.pps.mobile
 - com.mfw.roadbook
 - com.tuniu.app.ui
 - com.ifeng.newvideo
 - com.baidu.netdisk
 - com.quanleimu.activity
 - com.dragon.android.pandaspace
 - com.yuedong.sport
 - com.dongqiudi.news
 - air.fyzb3
 - com.managershare

In the latest update from Baidu, they already removed the malicious codes in the Moplus SDK and fixed the issue in its latest products. Upon checking the latest code of Baidu Map, we found out based on our static code analyis using the version 8.7.0 that they may still keep the NanoHttpd server open in user devices with the binded port still at 40310. Throughout our further analysis with Baidu, however, the code doesn’t work on the devices with the latest version, 8.7.5 released October 30.

 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus19.jpg)
Figure 19. Based on the static code analysis, Local HTTP server is kept in the latest Moplus update with same TCP port hardcoded.

They removed some malicious commands and their corresponding codes. They also remove the malicious part of installing applications silently and automatically for rooted devices. As seen in figure 21, not all malicious functionalities have been deleted by Moplus SDK, making devices still at risk.

 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus20.jpg)
Figure 20. Part of malicious commands remain in the latest Moplus SDK.

 ![](http://blog.trendmicro.com/trendlabs-security-intelligence/files/2015/11/moplus21.jpg)
Figure 21. Only malicious functionalities in red part have been removed in the latest Moplus SDK. 

How does Trend Micro protect users?

Trend Micro protects users via its Trend Micro Mobile Security that detects the malicious SDK (ANDROIDOS_WORMHOLE.HRXA) before it can be installed on the device. Its app virus scanner feature can scan installed apps to filter out the malicious apps. Our unlimited updates and cloud scanner technologies ensure continuous protection from any mobile malware.

We also recommend users to uninstall those infected applications unless there is an upgrade that confirms that the malicious behavior of the SDK has been totally removed. We’re currently monitoring this for any updates.

We already informed Google and Baidu regarding this security issue.

With additional data from threat analyst Jordan Pan. 

Update as of November 4, 2015, 2:35 A.M. PDT (UTC-7):
Baidu replied to Trend Micro that they have addressed the vulnerability since October 30, 2015. They have also submitted updated Baidu apps to Google Play, some of which have already been approved while others are still pending approval. Baidu will remove the problematic “dead code” in the next version releases of the affected apps. The images have also been updated.

Updated on November 4, 2015 8:42 P.M. PDT (UTC-7) to add more details on apps integrated Moplus SDK and the affected version throughout our further analysis with Baidu.
 
